# 在 Cursor 中测试 MCP 日志和进度显示

## 概述

本文档说明如何在 Cursor 中测试和验证 MCP 服务器的日志转发和进度显示功能。

## 功能说明

当前实现支持两种日志输出方式：

1. **MCP 日志通知**（主要方案）
   - 使用 MCP 协议标准的 `notifications/logging` 机制
   - 支持结构化日志数据
   - 支持多种日志级别（info、warning、error 等）

2. **stderr 输出**（后备方案）
   - 同时输出到 stderr，确保兼容性
   - 即使 MCP 日志通知失败，也能看到日志
   - 实时刷新，确保立即显示

## 测试步骤

### 1. 确保 MCP 服务器已配置

在 Cursor 的 MCP 配置中，确保 `foundry-sandbox` 服务器已正确配置：

```json
{
  "mcpServers": {
    "foundry-sandbox": {
      "command": "node",
      "args": ["/absolute/path/to/foundry-mcp/dist/index.js"]
    }
  }
}
```

### 2. 重启 Cursor

配置更改后，需要重启 Cursor 以使 MCP 服务器重新连接。

### 3. 准备测试项目

确保有一个 Foundry 项目，包含：
- `foundry.toml` 配置文件
- `test/` 目录（或测试文件）
- `dependencies.json` 文件（依赖清单）

**示例 `dependencies.json`**：
```json
["foundry-rs/forge-std"]
```

### 4. 调用工具测试

在 Cursor 的聊天界面中，请求 AI 调用 `forge_test` 工具：

```
请使用 foundry-sandbox MCP 服务器运行测试：
- 项目路径: /absolute/path/to/your/foundry/project
- 测试路径: test
- 依赖清单: dependencies.json
```

或者直接描述：

```
在沙盒中运行我的 Foundry 项目测试，项目路径是 /absolute/path/to/your/foundry/project
```

### 5. 观察日志输出

在工具执行过程中，你应该能在 Cursor 中看到以下日志：

#### 5.1 工具开始执行

```
═══════════════════════════════════════════════════════
🔧 开始执行 forge test 工具...
═══════════════════════════════════════════════════════
```

#### 5.2 参数验证

```
[MCP Log] ℹ️ ✅ 参数验证通过
[MCP Log] ℹ️ 📁 项目根目录: /path/to/project
[MCP Log] ℹ️ 📦 读取到 1 个依赖项
[MCP Log] ℹ️ 📝 测试路径: test
```

#### 5.3 执行步骤

```
═══════════════════════════════════════════════════════
🚀 步骤 1/4: 正在创建 Docker 容器...
═══════════════════════════════════════════════════════
[MCP Log] ℹ️ 🚀 步骤 1/4: 正在创建 Docker 容器...
[MCP Log] ℹ️ ✅ 步骤 1/4: Docker 容器创建成功

═══════════════════════════════════════════════════════
📦 步骤 2/4: 正在检查并安装 1 个依赖项...
═══════════════════════════════════════════════════════
[MCP Log] ℹ️ 📦 步骤 2/4: 正在检查并安装 1 个依赖项...
[MCP Log] ℹ️ ✅ 步骤 2/4: 依赖处理完成

═══════════════════════════════════════════════════════
🧪 步骤 3/4: 正在执行测试 (匹配路径: test/**/*.t.sol)...
═══════════════════════════════════════════════════════
📋 测试输出:
───────────────────────────────────────────────────────
[实际的 forge test 输出]
───────────────────────────────────────────────────────
[MCP Log] ℹ️ ✅ 步骤 3/4: 测试执行完成

═══════════════════════════════════════════════════════
🧹 步骤 4/4: 正在清理 Docker 容器...
═══════════════════════════════════════════════════════
[MCP Log] ℹ️ 🧹 步骤 4/4: 正在清理 Docker 容器...
[MCP Log] ℹ️ ✅ 步骤 4/4: Docker 容器清理完成
```

#### 5.4 工具完成

```
[MCP Log] ℹ️ 🎉 工具执行完成: PASS
```

## 日志格式说明

### MCP 日志通知格式

每条日志包含：
- **时间戳**：ISO 8601 格式
- **日志级别**：info、warning、error 等
- **Logger 名称**：`forge-test`
- **结构化数据**：
  - `message`：日志消息
  - `action`：操作类型（tool_start、create_container、run_tests 等）
  - `step`：当前步骤（1-4）
  - `total`：总步骤数（4）
  - `timestamp`：时间戳

### stderr 输出格式

```
[HH:mm:ss] [MCP Log] [级别图标] 日志消息
```

级别图标：
- `ℹ️`：info 级别
- `⚠️`：warning 级别
- `❌`：error 级别

## 验证要点

### ✅ 应该看到的内容

1. **实时日志**：日志应该在工具执行过程中实时显示，而不是等到工具完成后才显示
2. **结构化信息**：每个步骤都有清晰的标识（步骤 1/4、步骤 2/4 等）
3. **进度更新**：能看到每个步骤的开始和完成状态
4. **错误信息**：如果出现错误，应该看到清晰的错误日志

### ❌ 可能的问题

1. **看不到日志**：
   - 检查 MCP 服务器是否已正确配置
   - 检查 Cursor 是否已重启
   - 查看 Cursor 的 MCP 日志（如果有）

2. **日志延迟**：
   - 这是正常的，MCP 日志通知是异步的
   - stderr 输出应该能实时显示

3. **日志格式混乱**：
   - 检查代码是否正确编译（运行 `yarn build`）
   - 确保使用的是最新版本的代码

## 调试技巧

### 1. 查看 MCP 服务器日志

如果 Cursor 支持查看 MCP 服务器日志，可以检查：
- 服务器是否正常启动
- 日志通知是否成功发送
- 是否有错误信息

### 2. 测试 stderr 输出

即使 MCP 日志通知失败，stderr 输出也应该能看到。如果看不到任何日志，可能是：
- Cursor 没有正确转发 stderr
- MCP 服务器没有正常启动

### 3. 验证日志通知

在代码中，`sendLoggingMessage` 方法会：
1. 首先尝试发送 MCP 日志通知
2. 同时输出到 stderr（确保兼容性）
3. 如果 MCP 日志通知失败，会在 stderr 中显示错误信息

## 测试用例

### 测试用例 1：正常执行

**输入**：
```
在沙盒中运行测试，项目路径是 /path/to/project
```

**预期输出**：
- 看到工具开始执行的日志
- 看到 4 个步骤的进度日志
- 看到测试结果
- 看到工具完成的日志

### 测试用例 2：错误处理

**输入**：
```
在沙盒中运行测试，项目路径是 /invalid/path
```

**预期输出**：
- 看到工具开始执行的日志
- 看到错误日志（❌ 项目根目录不存在）
- 看到工具执行失败的日志

### 测试用例 3：依赖安装

**输入**：
```
在沙盒中运行测试，项目路径是 /path/to/project，依赖清单是 dependencies.json
```

**预期输出**：
- 看到依赖读取的日志
- 看到依赖安装的进度日志
- 看到依赖安装的实时输出

## 总结

当前实现提供了双重保障：
1. **MCP 日志通知**：符合协议标准，支持结构化数据
2. **stderr 输出**：确保兼容性，即使客户端不支持日志通知也能看到日志

在 Cursor 中，你应该能看到：
- ✅ 实时日志输出
- ✅ 清晰的进度信息
- ✅ 结构化的日志数据
- ✅ 错误和警告信息

如果遇到问题，请检查：
1. MCP 服务器配置是否正确
2. Cursor 是否已重启
3. 代码是否已正确编译
4. Docker 环境是否正常

